<html xmlns:th="http://www.thymeleaf.org" lang="en"
	xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity5"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout-shop}">
<head>
<meta charset="UTF-8" />
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

<!-- Bootstrap CSS -->
<meta name="viewport" content="width=device-width, initial-scale=1">
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
	rel="stylesheet"
	integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
	crossorigin="anonymous">
<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
<title>Giỏ hàng</title>
</head>
<body>
	<div layout:fragment="content">
		<!-- cú pháp Jquery: ý nghĩa chờ cái trang html vẽ lên xong r mới xử lý code -->
		<script>
			function findCartLine(productId, data) {
				for (let i = 0; i < data.cartLines.length; i++) {
					if (data.cartLines[i].productInfo.productId == productId) {
						return data.cartLines[i];
					}
				}

				return null;
			}
			$(document)
					.ready(
							function() {
								$("#message").hide();
								$('.quantity').focusin(function() {
									$(this).attr('oldvalue', $(this).val());
								});

								$(".quantity")
										.change(
												function() {
													var oldValue = $(this)
															.attr('oldvalue');

													var quantity = $(this)
															.val();
													var productIdInput = $(this)
															.parent().parent()
															.children().eq(2);
													var productId = productIdInput
															.val();

													var url = "/api/cart/update-quantity?productId="
															+ productId
															+ "&quantity="
															+ quantity;
													var quantityInput = $(this);
													var totalPriceElem = $(this)
															.parent().parent()
															.children().eq(6);

													$
															.get(
																	url,
																	function(
																			data,
																			status) {
																		console
																				.log(data);
																		var msg = data.message;
																		var cartLine = findCartLine(
																				productId,
																				data);
																		totalPriceElem
																				.html(cartLine.amount);
																		$(
																				"#amountTotal")
																				.html(
																						data.amountTotal);
																		if (msg != null
																				&& msg != "") {
																			//alert(msg);
																			$(
																					"#message")
																					.html(
																							msg);
																			$(
																					"#message")
																					.show();
																			quantityInput
																					.val(oldValue);
																		} else {
																			$(
																					"#message")
																					.hide();
																		}
																	});
												});

							});
		</script>
		<div class="entry-header-area pb-50 pdtop">
			<div class="container">
				<div class="row">
					<div class="col">
						<div class="entry-header">
							<h1 class="entry-title mt-5" align="center">Giỏ hàng của bạn</h1>
							<div id="message" class="alert alert-danger" role="alert">
								A simple danger alert—check it out!</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="cart-main-area pb-50">
			<div class="container-fluid">
				<!-- cart-main-area start -->
				<div class="cart-main-area ptb-40">
					<div class="container">
						<div class="row">
							<div class="col">
								<div class="table-responsive">
									<div></div>

									<table id="mainCartTable"
										class="table table-hover table-condensed">

										<thead>
											<tr>
												<th>Ảnh sản phẩm</th>
												<th>Mã sản phẩm</th>
												<th>Tên sản phẩm</th>

												<th>Giá</th>
												<th>Số lượng</th>

												<th>Thành tiền</th>
												<th>Xóa sản phẩm</th>

											</tr>
										</thead>
										<tbody>
											<form
												th:if="${cartForm != null && cartForm.cartLines != null && !cartForm.cartLines.empty}"
												method="POST" th:action="@{/shop/shoppingCart}"
												th:object="${cartForm}">
												<div class="row">

													<tr th:each="cartLineInfo,itemStat:*{cartLines}">
														<td data-th="Image">
															<div class="row-cart">
																<div class="col-sm-4 hidden-xs">
																	<img width="75" height=50 src=""
																		th:attr="src=@{/upload/{path}(path=${cartLineInfo.productInfo.defaultImage})}" />
																</div>
															</div>
														</td>
														<td width="15%"
															th:text="${cartLineInfo.productInfo.productID}"></td>
														<input type="hidden"
															th:field="*{cartLines[__${itemStat.index}__].productInfo.productID}" />
														<td class="col"
															th:text="${cartLineInfo.productInfo.productName}"></td>
														<td class="col"><strong
															th:text="${#numbers.formatInteger(cartLineInfo.productInfo.price,3,'POINT')} + ' ' +  VND"></strong>
														</td>
														<td class="col"><input type="number" class="quantity"
														th:attr="oldvalue=*{cartLines[__${itemStat.index}__].quantity}"
															th:field="*{cartLines[__${itemStat.index}__].quantity}" />
														</td>

														<td class="amountTotal"
															th:text="${#numbers.formatInteger(cartLineInfo.amount,3,'POINT')} + ' '  + VND"></td>
														<td class="col"><a class="btn btn-danger"
															th:href="@{/shop/shoppingCartRemoveProduct?(productID=${cartLineInfo.productInfo.productID})}">
																<i class="fas fa-trash-alt"></i> Xóa

														</a></td>
													</tr>

												</div>
												<div class="row">
													<div class="col-lg-8"></div>
													<div class="col">
														<input class="button-update-sc btn btn-outline-primary"
															type="submit" value="Cập nhật số lượng" />
													</div>
												</div>
												<!-- <tr th:each="cartLineInfo,itemStat:*{cartLines}">
														<td data-th="Image">
															<div class="row-cart">
																<div class="col-sm-4 hidden-xs">
																	<img width="75" height=50 src=""
																		th:attr="src=@{/upload/{path}(path=${cartLineInfo.productInfo.defaultImage})}" />
																</div>
															</div>
														</td>
														<td width="15%"
															th:text="${cartLineInfo.productInfo.productID}"></td>
														<input type="hidden"
															th:field="*{cartLines[__${itemStat.index}__].productInfo.productID}" />
														<td class="col"
															th:text="${cartLineInfo.productInfo.productName}"></td>
														<td class="col">
															<strong th:text="${#numbers.formatInteger(cartLineInfo.productInfo.price,3,'POINT')}"></strong>
														</td>
														<td class="col"><input type="number"
															th:field="*{cartLines[__${itemStat.index}__].quantity}" />
														</td>
														
														<td
															th:text="${#numbers.formatInteger(cartLineInfo.amount,3,'POINT')}"></td>
														<td class="col"><a class="btn btn-danger"
															th:href="@{/shop/shoppingCartRemoveProduct?(productID=${cartLineInfo.productInfo.productID})}">
																<i class="fas fa-trash-alt"></i> Xóa

														</a></td>
													</tr> -->




											</form>
										</tbody>
									</table>
								</div>
								<div class="row">
									<div class="col-lg-8 col-md-8 col-sm-7 col-xs-12">
										<div class="buttons-cart pdtop">
											<a class="btn btn-primary" th:href="@{/}">Tiếp tục mua
												hàng</a>
										</div>
									</div>
								</div>
								<div class="row">
									<div class="col-lg-4 col-md-4 col-sm-5 col-xs-12">

										<div class="cart_totals">
											<h2>Tổng cộng</h2>
											<div class="cart-totals-table">
												<table class="table">
													<tbody>
														<tr class="cart-subtotal">
															<th>Tổng cộng</th>
															<td id="amountTotal"
																th:text="${#numbers.formatInteger(cartForm.amountTotal,0,'POINT')} + ' ' +VND"></td>
														</tr>
													</tbody>
												</table>
											</div>
										</div>

										<div class="wc-proceed-to-checkout pdbottom">
											<a th:href="@{/shop/shoppingCartConfirmation}"
												class="btn btn-primary">Thanh toán</a>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
</body>
</html>